<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Background Debug Console</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: "Courier New", monospace;
        background: #000;
        color: #0f0;
        font-size: 14px;
      }
      .console {
        background: #111;
        border: 1px solid #333;
        padding: 10px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .status {
        background: #222;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid #0f0;
      }
      .error {
        border-left-color: #f00;
        color: #f88;
      }
      .warning {
        border-left-color: #fa0;
        color: #ffa;
      }
      button {
        background: #333;
        color: #0f0;
        border: 1px solid #555;
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      button:hover {
        background: #444;
      }
    </style>
  </head>
  <body>
    <h1>üîç BACKGROUND ROTATION DEBUG CONSOLE</h1>

    <div class="status" id="browser-info">
      <strong>Browser:</strong> <span id="browser-name">Detecting...</span
      ><br />
      <strong>User Agent:</strong> <span id="user-agent"></span>
    </div>

    <div class="status">
      <strong>Manifest Status:</strong>
      <span id="manifest-status">Loading...</span><br />
      <strong>Images Found:</strong> <span id="images-count">0</span><br />
      <strong>Current Image:</strong> <span id="current-image">None</span><br />
      <strong>Rotation Count:</strong> <span id="rotation-count">0</span><br />
      <strong>Timer Active:</strong> <span id="timer-status">Unknown</span>
    </div>

    <button onclick="testImageLoad()">Test Image Loading</button>
    <button onclick="testManifest()">Test Manifest</button>
    <button onclick="forceRotation()">Force Rotation</button>
    <button onclick="clearConsole()">Clear Console</button>

    <div class="console" id="console-output"></div>

    <script>
      let consoleLog = [];
      let rotationCount = 0;
      let manifest = null;
      let images = [];
      let currentIndex = 0;

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        consoleLog.push(logEntry);

        const consoleEl = document.getElementById("console-output");
        consoleEl.textContent = consoleLog.slice(-50).join("\n");
        consoleEl.scrollTop = consoleEl.scrollHeight;

        // Also log to browser console
        if (type === "error") console.error(message);
        else if (type === "warning") console.warn(message);
        else console.log(message);
      }

      function detectBrowser() {
        const ua = navigator.userAgent;
        document.getElementById("user-agent").textContent = ua;

        let browser = "Unknown";
        if (ua.includes("Chrome") && !ua.includes("Edg"))
          browser = "Chrome/Chromium";
        else if (ua.includes("Firefox")) browser = "Firefox";
        else if (ua.includes("Safari") && !ua.includes("Chrome"))
          browser = "Safari";
        else if (ua.includes("Edg")) browser = "Edge";
        else if (ua.includes("VSCode")) browser = "VS Code Simple Browser";

        document.getElementById("browser-name").textContent = browser;
        log(`Browser detected: ${browser}`);
      }

      function testManifest() {
        log("Testing manifest.json loading...");
        fetch("manifest.json")
          .then((response) => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then((data) => {
            manifest = data;
            document.getElementById("manifest-status").textContent =
              "Loaded ‚úÖ";
            log(`Manifest loaded successfully: ${data.count} images`);

            // Generate image paths
            images = [];
            for (let i = 1; i <= data.count; i++) {
              const num =
                data.pad && data.count > 9 ? String(i).padStart(2, "0") : i;
              const path = `${data.path}/bg${num}.${data.extension}`;
              images.push(path);
            }

            document.getElementById("images-count").textContent = images.length;
            log(`Generated ${images.length} image paths`);
          })
          .catch((error) => {
            document.getElementById("manifest-status").textContent =
              "Failed ‚ùå";
            log(`Manifest loading failed: ${error.message}`, "error");
          });
      }

      function testImageLoad() {
        if (!images.length) {
          log("No images available. Test manifest first.", "warning");
          return;
        }

        const testImg = images[Math.floor(Math.random() * images.length)];
        log(`Testing image load: ${testImg}`);

        const img = new Image();
        const startTime = performance.now();

        img.onload = () => {
          const loadTime = Math.round(performance.now() - startTime);
          log(`‚úÖ Image loaded successfully in ${loadTime}ms: ${testImg}`);
        };

        img.onerror = () => {
          log(`‚ùå Image failed to load: ${testImg}`, "error");
        };

        img.src = testImg;
      }

      function forceRotation() {
        if (!images.length) {
          log("No images available for rotation test.", "warning");
          return;
        }

        currentIndex = (currentIndex + 1) % images.length;
        const newImage = images[currentIndex];

        document.getElementById("current-image").textContent = newImage;
        rotationCount++;
        document.getElementById("rotation-count").textContent = rotationCount;

        log(`Manual rotation to: ${newImage}`);
      }

      function clearConsole() {
        consoleLog = [];
        document.getElementById("console-output").textContent = "";
      }

      // Check if bg-loader.js is working
      function checkBgLoader() {
        if (window.bgLoader) {
          log("‚úÖ bg-loader.js detected");
        } else {
          log("‚ùå bg-loader.js not found", "warning");
        }

        // Check for interval timers
        const intervals = [];
        const originalSetInterval = window.setInterval;
        let intervalCount = 0;

        window.setInterval = function (fn, delay) {
          intervalCount++;
          log(`Timer created: ${delay}ms interval (#${intervalCount})`);
          return originalSetInterval.call(this, fn, delay);
        };

        document.getElementById(
          "timer-status"
        ).textContent = `${intervalCount} timers created`;
      }

      // Initialize
      detectBrowser();
      testManifest();
      checkBgLoader();

      // Monitor for background changes
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (
            mutation.target.classList &&
            mutation.target.classList.contains("bg-image")
          ) {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              if (mutation.target.classList.contains("active")) {
                const bgUrl = mutation.target.style.backgroundImage;
                log(`üîÑ Background changed to: ${bgUrl}`);
              }
            }
          }
        });
      });

      // Start observing once DOM loads
      setTimeout(() => {
        const bgContainer = document.getElementById("bg-container");
        if (bgContainer) {
          observer.observe(bgContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ["class", "style"],
          });
          log("‚úÖ Background rotation monitor started");
        } else {
          log(
            "‚ùå bg-container not found - background system may not be initialized",
            "error"
          );
        }
      }, 2000);
    </script>
  </body>
</html>
