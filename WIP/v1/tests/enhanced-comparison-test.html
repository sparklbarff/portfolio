<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Background Loader Test</title>
    <link rel="stylesheet" href="assets/css/crt.css" />
    <style>
      body {
        margin: 0;
        font-family: "Courier New", monospace;
        background: #000;
        color: #0f0;
        overflow: auto;
      }

      .test-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: 100vh;
        gap: 2px;
      }

      .test-section {
        position: relative;
        border: 2px solid #333;
        overflow: hidden;
      }

      .test-header {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border: 1px solid #555;
        font-size: 12px;
        max-width: 300px;
      }

      .status-line {
        margin: 3px 0;
      }

      .success {
        color: #0f0;
      }
      .error {
        color: #f00;
      }
      .warning {
        color: #fa0;
      }

      .controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 1000;
      }

      .controls button {
        background: #333;
        color: #0f0;
        border: 1px solid #555;
        padding: 5px 10px;
        margin: 2px;
        cursor: pointer;
        font-size: 10px;
      }

      .controls button:hover {
        background: #444;
      }

      #bg-container-original,
      #bg-container-enhanced {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }

      .version-label {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: rgba(0, 255, 255, 0.5);
        text-shadow: 0 0 10px cyan;
        pointer-events: none;
        z-index: 100;
      }

      .console-mini {
        position: absolute;
        top: 120px;
        right: 10px;
        width: 200px;
        height: 150px;
        background: rgba(0, 0, 0, 0.9);
        border: 1px solid #333;
        padding: 5px;
        font-size: 9px;
        overflow-y: scroll;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <!-- LEFT: Original bg-loader.js -->
      <div class="test-section" id="original-section">
        <div class="version-label">ORIGINAL</div>
        <div id="bg-container-original"></div>

        <div class="test-header">
          <h4>🔴 ORIGINAL BG-LOADER</h4>
          <div class="status-line">
            Status: <span id="original-status">Loading...</span>
          </div>
          <div class="status-line">
            Images: <span id="original-count">0</span>
          </div>
          <div class="status-line">
            Current: <span id="original-current">None</span>
          </div>
          <div class="status-line">
            Rotations: <span id="original-rotations">0</span>
          </div>
        </div>

        <div class="controls">
          <button onclick="startOriginal()">Start Original</button>
          <button onclick="stopOriginal()">Stop</button>
          <button onclick="forceOriginal()">Force Next</button>
        </div>

        <div class="console-mini" id="original-console"></div>
      </div>

      <!-- RIGHT: Enhanced bg-loader-enhanced.js -->
      <div class="test-section" id="enhanced-section">
        <div class="version-label">ENHANCED</div>
        <div id="bg-container-enhanced"></div>

        <div class="test-header">
          <h4>🟢 ENHANCED BG-LOADER</h4>
          <div class="status-line">
            Status: <span id="enhanced-status">Loading...</span>
          </div>
          <div class="status-line">
            Images: <span id="enhanced-count">0</span>
          </div>
          <div class="status-line">
            Current: <span id="enhanced-current">None</span>
          </div>
          <div class="status-line">
            Rotations: <span id="enhanced-rotations">0</span>
          </div>
          <div class="status-line">
            Support: <span id="enhanced-support">Checking...</span>
          </div>
        </div>

        <div class="controls">
          <button onclick="startEnhanced()">Start Enhanced</button>
          <button onclick="stopEnhanced()">Stop</button>
          <button onclick="forceEnhanced()">Force Next</button>
          <button onclick="showSupport()">Show Support</button>
        </div>

        <div class="console-mini" id="enhanced-console"></div>
      </div>
    </div>

    <script>
      let originalRotations = 0;
      let enhancedRotations = 0;

      // Console logging utilities
      function logOriginal(message) {
        const console = document.getElementById("original-console");
        const timestamp = new Date().toLocaleTimeString();
        console.innerHTML += `[${timestamp}] ${message}\n`;
        console.scrollTop = console.scrollHeight;
      }

      function logEnhanced(message) {
        const console = document.getElementById("enhanced-console");
        const timestamp = new Date().toLocaleTimeString();
        console.innerHTML += `[${timestamp}] ${message}\n`;
        console.scrollTop = console.scrollHeight;
      }

      // Override console.log to capture bg-loader messages
      const originalConsoleLog = console.log;
      const originalConsoleWarn = console.warn;
      const originalConsoleError = console.error;

      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        const message = args.join(" ");
        if (
          message.includes("Background Loader") ||
          message.includes("bg-loader") ||
          message.includes("🔄") ||
          message.includes("✅") ||
          message.includes("❌")
        ) {
          if (message.includes("Enhanced") || message.includes("enhanced")) {
            logEnhanced(`LOG: ${message}`);
          } else {
            logOriginal(`LOG: ${message}`);
          }
        }
      };

      console.warn = function (...args) {
        originalConsoleWarn.apply(console, args);
        const message = args.join(" ");
        logEnhanced(`WARN: ${message}`);
      };

      console.error = function (...args) {
        originalConsoleError.apply(console, args);
        const message = args.join(" ");
        logOriginal(`ERROR: ${message}`);
        logEnhanced(`ERROR: ${message}`);
      };

      // Monitoring functions
      function updateStatus() {
        // Check original status
        const originalBg = document.querySelector(
          "#bg-container-original .bg-image.active"
        );
        if (originalBg) {
          document.getElementById("original-status").textContent = "Running ✅";
          document.getElementById("original-status").className = "success";
          const bgUrl = originalBg.style.backgroundImage;
          const match = bgUrl.match(/bg(\d+)\.png/);
          if (match) {
            document.getElementById(
              "original-current"
            ).textContent = `bg${match[1]}.png`;
          }
        }

        // Check enhanced status
        const enhancedBg = document.querySelector(
          "#bg-container-enhanced .bg-image.active"
        );
        if (enhancedBg) {
          document.getElementById("enhanced-status").textContent = "Running ✅";
          document.getElementById("enhanced-status").className = "success";
          const bgUrl = enhancedBg.style.backgroundImage;
          const match = bgUrl.match(/bg(\d+)\.png/);
          if (match) {
            document.getElementById(
              "enhanced-current"
            ).textContent = `bg${match[1]}.png`;
          }
        }

        // Update browser support info
        if (window.bgLoader && window.bgLoader.browserSupport) {
          const support = window.bgLoader.browserSupport;
          const supportText = `Fetch:${support.fetch ? "✅" : "❌"} CSS:${
            support.cssCustomProperties ? "✅" : "❌"
          } RAF:${support.requestAnimationFrame ? "✅" : "❌"}`;
          document.getElementById("enhanced-support").textContent = supportText;
        }
      }

      // Monitor for background changes
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (
            mutation.target.classList &&
            mutation.target.classList.contains("bg-image")
          ) {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              if (mutation.target.classList.contains("active")) {
                const container = mutation.target.closest(
                  "#bg-container-original, #bg-container-enhanced"
                );
                if (container && container.id === "bg-container-original") {
                  originalRotations++;
                  document.getElementById("original-rotations").textContent =
                    originalRotations;
                  logOriginal(`🔄 Background rotated (${originalRotations})`);
                } else if (
                  container &&
                  container.id === "bg-container-enhanced"
                ) {
                  enhancedRotations++;
                  document.getElementById("enhanced-rotations").textContent =
                    enhancedRotations;
                  logEnhanced(`🔄 Background rotated (${enhancedRotations})`);
                }
              }
            }
          }
        });
      });

      // Start observing both containers
      setTimeout(() => {
        const originalContainer = document.getElementById(
          "bg-container-original"
        );
        const enhancedContainer = document.getElementById(
          "bg-container-enhanced"
        );

        if (originalContainer) {
          observer.observe(originalContainer, {
            childList: true,
            subtree: true,
            attributes: true,
          });
          logOriginal("👁️ Monitoring started");
        }

        if (enhancedContainer) {
          observer.observe(enhancedContainer, {
            childList: true,
            subtree: true,
            attributes: true,
          });
          logEnhanced("👁️ Monitoring started");
        }
      }, 1000);

      // Control functions
      function startOriginal() {
        logOriginal("🚀 Starting original bg-loader test...");
        // Original loader will auto-start, just update status
        document.getElementById("original-status").textContent = "Starting...";
      }

      function stopOriginal() {
        logOriginal(
          "⏹️ Original bg-loader cannot be stopped (no external API)"
        );
      }

      function forceOriginal() {
        logOriginal("⏭️ Original bg-loader has no force method");
      }

      function startEnhanced() {
        if (window.bgLoader && window.bgLoader.restart) {
          logEnhanced("🚀 Restarting enhanced bg-loader...");
          window.bgLoader.restart();
        } else {
          logEnhanced("❌ Enhanced bg-loader not available");
        }
      }

      function stopEnhanced() {
        logEnhanced("⏹️ Enhanced bg-loader auto-pauses when hidden");
      }

      function forceEnhanced() {
        if (window.bgLoader && window.bgLoader.forceNext) {
          logEnhanced("⏭️ Forcing next background...");
          window.bgLoader.forceNext();
        } else {
          logEnhanced("❌ Enhanced bg-loader not available");
        }
      }

      function showSupport() {
        if (window.bgLoader && window.bgLoader.browserSupport) {
          const support = window.bgLoader.browserSupport;
          logEnhanced(`Browser Support Report:`);
          logEnhanced(`- Fetch API: ${support.fetch ? "YES" : "NO"}`);
          logEnhanced(
            `- CSS Custom Properties: ${
              support.cssCustomProperties ? "YES" : "NO"
            }`
          );
          logEnhanced(
            `- requestAnimationFrame: ${
              support.requestAnimationFrame ? "YES" : "NO"
            }`
          );
          logEnhanced(
            `- Visibility API: ${support.visibilityAPI ? "YES" : "NO"}`
          );
        } else {
          logEnhanced("❌ Enhanced bg-loader not loaded yet");
        }
      }

      // Update status every second
      setInterval(updateStatus, 1000);

      // Initial status
      logOriginal("🔄 Ready to test original bg-loader");
      logEnhanced("🔄 Ready to test enhanced bg-loader");

      document.getElementById("original-count").textContent = "31 (expected)";
      document.getElementById("enhanced-count").textContent = "31 (expected)";
    </script>

    <!-- Load original first (modified to use original container) -->
    <script>
      // Modified original bg-loader for comparison
      (function () {
        "use strict";

        const bgContainer = document.getElementById("bg-container-original");
        if (!bgContainer) return;

        let manifest = null;
        let currentIndex = 0;
        let images = [];
        let preloadedImages = new Map();
        let cycleTimer = null;
        let isTransitioning = false;

        function fetchManifest() {
          return fetch("manifest.json")
            .then((response) => {
              if (!response.ok) throw new Error("Failed to load manifest.json");
              return response.json();
            })
            .catch((error) => {
              console.error("Error loading background manifest:", error);
              return {
                count: 31,
                pad: false,
                path: "assets/images",
                extension: "png",
                preload: 2,
              };
            });
        }

        function generateImagePaths() {
          if (!manifest || manifest.count <= 0) return [];

          const results = [];
          const padZero = manifest.pad && manifest.count > 9;

          for (let i = 1; i <= manifest.count; i++) {
            const num = padZero ? String(i).padStart(2, "0") : i;
            const path = `${manifest.path}/bg${num}.${manifest.extension}`;
            results.push(path);
          }

          return results;
        }

        function preloadImage(src) {
          if (preloadedImages.has(src)) {
            return Promise.resolve(preloadedImages.get(src));
          }

          return new Promise((resolve, reject) => {
            const img = new Image();

            img.onload = () => {
              preloadedImages.set(src, img);
              resolve(img);
            };

            img.onerror = () => {
              reject(new Error(`Failed to load image: ${src}`));
            };

            img.src = src;
          });
        }

        function createBackgroundElement(src) {
          const div = document.createElement("div");
          div.className = "bg-image";
          div.style.backgroundImage = `url(${src})`;
          return div;
        }

        function transitionToNext() {
          if (isTransitioning || !images.length) return;
          isTransitioning = true;

          const nextIndex = (currentIndex + 1) % images.length;
          const currentSrc = images[currentIndex];
          const nextSrc = images[nextIndex];

          const current = bgContainer.querySelector(
            `.bg-image[style*="${currentSrc}"]`
          );
          let next = bgContainer.querySelector(
            `.bg-image[style*="${nextSrc}"]`
          );

          if (!next) {
            next = createBackgroundElement(nextSrc);
            bgContainer.appendChild(next);
          }

          setTimeout(() => {
            if (current) {
              current.classList.remove("active");
            }

            next.classList.add("active");

            setTimeout(() => {
              currentIndex = nextIndex;
              isTransitioning = false;

              const oldImages = bgContainer.querySelectorAll(
                ".bg-image:not(.active)"
              );
              if (oldImages.length > 3) {
                Array.from(oldImages)
                  .slice(0, oldImages.length - 3)
                  .forEach((img) => img.remove());
              }
            }, 500);
          }, 50);
        }

        function setupCycle() {
          if (cycleTimer) {
            clearInterval(cycleTimer);
          }

          const period =
            parseFloat(
              getComputedStyle(document.documentElement).getPropertyValue(
                "--period"
              )
            ) * 1000 || 7000;
          cycleTimer = setInterval(transitionToNext, period);
        }

        function setupFirstBg() {
          if (!images.length)
            return Promise.reject(new Error("No background images available"));

          const firstSrc = images[0];
          return preloadImage(firstSrc)
            .then(() => {
              const first = createBackgroundElement(firstSrc);
              bgContainer.appendChild(first);

              setTimeout(() => {
                first.classList.add("active");
                isTransitioning = false;
              }, 100);
            })
            .catch((error) => {
              console.error("Error setting up initial background:", error);
            });
        }

        function initBackgrounds() {
          return fetchManifest()
            .then((data) => {
              manifest = data;
              images = generateImagePaths();

              if (!images.length) {
                console.error("No background images defined in manifest");
                return;
              }

              return setupFirstBg();
            })
            .then(() => {
              setupCycle();
            })
            .catch((error) => {
              console.error("Failed to initialize backgrounds:", error);
            });
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initBackgrounds);
        } else {
          initBackgrounds();
        }
      })();
    </script>

    <!-- Load enhanced version (uses enhanced container) -->
    <script>
      // Wait a bit then load enhanced version
      setTimeout(() => {
        // Modify the enhanced loader to use the enhanced container
        const script = document.createElement("script");
        script.textContent = `
                (function () {
                  "use strict";

                  const bgContainer = document.getElementById("bg-container-enhanced");
                  if (!bgContainer) return;

                  let manifest = null;
                  let currentIndex = 0;
                  let images = [];
                  let preloadedImages = new Map();
                  let cycleTimer = null;
                  let isTransitioning = false;

                  // Cross-browser compatibility detection
                  const browserSupport = {
                    fetch: typeof fetch !== 'undefined',
                    cssCustomProperties: (() => {
                      try {
                        const testEl = document.createElement('div');
                        testEl.style.setProperty('--test', '1');
                        const value = getComputedStyle(testEl).getPropertyValue('--test');
                        return value.trim() === '1';
                      } catch (e) {
                        return false;
                      }
                    })(),
                    requestAnimationFrame: typeof requestAnimationFrame !== 'undefined',
                    visibilityAPI: typeof document.hidden !== 'undefined'
                  };

                  console.log('🔍 Enhanced Background Loader - Browser Support:', browserSupport);

                  // Enhanced manifest fetching with fallback
                  function fetchManifest() {
                    if (browserSupport.fetch) {
                      return fetch("manifest.json")
                        .then((response) => {
                          if (!response.ok) throw new Error(\`HTTP \${response.status}\`);
                          return response.json();
                        })
                        .catch((error) => {
                          console.warn("Fetch failed, trying XMLHttpRequest fallback:", error);
                          return fetchManifestFallback();
                        });
                    } else {
                      console.log("Using XMLHttpRequest for manifest loading");
                      return fetchManifestFallback();
                    }
                  }

                  // XMLHttpRequest fallback for older browsers
                  function fetchManifestFallback() {
                    return new Promise((resolve, reject) => {
                      const xhr = new XMLHttpRequest();
                      xhr.open('GET', 'manifest.json', true);
                      xhr.timeout = 5000; // 5 second timeout
                      
                      xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                          if (xhr.status === 200) {
                            try {
                              resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                              console.error("JSON parse error:", e);
                              resolve(getDefaultManifest());
                            }
                          } else {
                            console.error(\`XMLHttpRequest failed: \${xhr.status}\`);
                            resolve(getDefaultManifest());
                          }
                        }
                      };

                      xhr.onerror = () => {
                        console.error("Network error loading manifest");
                        resolve(getDefaultManifest());
                      };

                      xhr.ontimeout = () => {
                        console.error("Timeout loading manifest");
                        resolve(getDefaultManifest());
                      };

                      xhr.send();
                    });
                  }

                  // Default manifest if loading fails
                  function getDefaultManifest() {
                    console.log("Using default manifest configuration");
                    return {
                      count: 31,
                      pad: false,
                      path: "assets/images",
                      extension: "png",
                      preload: 2,
                    };
                  }

                  function generateImagePaths() {
                    if (!manifest || manifest.count <= 0) return [];

                    const results = [];
                    const padZero = manifest.pad && manifest.count > 9;

                    for (let i = 1; i <= manifest.count; i++) {
                      const num = padZero ? String(i).padStart(2, "0") : i;
                      const path = \`\${manifest.path}/bg\${num}.\${manifest.extension}\`;
                      results.push(path);
                    }

                    return results;
                  }

                  // Enhanced image preloading with timeout and retry
                  function preloadImage(src, timeout = 10000) {
                    if (preloadedImages.has(src)) {
                      return Promise.resolve(preloadedImages.get(src));
                    }

                    return new Promise((resolve, reject) => {
                      const img = new Image();
                      let timeoutId;

                      const cleanup = () => {
                        if (timeoutId) clearTimeout(timeoutId);
                      };

                      const onSuccess = () => {
                        cleanup();
                        preloadedImages.set(src, img);
                        console.log(\`✅ Enhanced loaded: \${src}\`);
                        resolve(img);
                      };

                      const onError = (error) => {
                        cleanup();
                        console.warn(\`❌ Enhanced failed to load: \${src}\`, error);
                        resolve(null);
                      };

                      img.onload = onSuccess;
                      img.onerror = onError;

                      timeoutId = setTimeout(() => {
                        console.warn(\`⏰ Enhanced timeout loading: \${src}\`);
                        onError(new Error('Image load timeout'));
                      }, timeout);

                      img.src = src;
                    });
                  }

                  function createBackgroundElement(src) {
                    const div = document.createElement("div");
                    div.className = "bg-image";
                    div.style.backgroundImage = \`url(\${src})\`;
                    
                    // Fallback inline styles for browsers with poor CSS support
                    if (!browserSupport.cssCustomProperties) {
                      div.style.position = 'absolute';
                      div.style.top = '0';
                      div.style.left = '0';
                      div.style.width = '100%';
                      div.style.height = '100%';
                      div.style.backgroundSize = 'cover';
                      div.style.backgroundPosition = 'center';
                      div.style.opacity = '0';
                      div.style.transition = 'opacity 2s ease-in-out';
                    }
                    
                    return div;
                  }

                  function transitionToNext() {
                    if (isTransitioning || !images.length) return;
                    isTransitioning = true;

                    const nextIndex = (currentIndex + 1) % images.length;
                    const currentSrc = images[currentIndex];
                    const nextSrc = images[nextIndex];

                    console.log(\`🔄 Enhanced transitioning: bg\${currentIndex + 1}.png → bg\${nextIndex + 1}.png\`);

                    const current = bgContainer.querySelector(
                      \`.bg-image[style*="\${currentSrc}"]\`
                    );
                    let next = bgContainer.querySelector(\`.bg-image[style*="\${nextSrc}"]\`);

                    if (!next) {
                      next = createBackgroundElement(nextSrc);
                      bgContainer.appendChild(next);
                    }

                    setTimeout(() => {
                      if (current) {
                        current.classList.remove("active");
                        if (!browserSupport.cssCustomProperties) {
                          current.style.opacity = '0';
                        }
                      }

                      next.classList.add("active");
                      if (!browserSupport.cssCustomProperties) {
                        next.style.opacity = '1';
                      }

                      setTimeout(() => {
                        currentIndex = nextIndex;
                        isTransitioning = false;

                        const oldImages = bgContainer.querySelectorAll(
                          ".bg-image:not(.active)"
                        );
                        if (oldImages.length > 3) {
                          Array.from(oldImages)
                            .slice(0, oldImages.length - 3)
                            .forEach((img) => img.remove());
                        }

                        console.log(\`✅ Enhanced transition complete: bg\${nextIndex + 1}.png active\`);
                      }, 500);
                    }, 50);
                  }

                  function setupCycle() {
                    if (cycleTimer) {
                      clearInterval(cycleTimer);
                      cycleTimer = null;
                    }

                    let period = 7000; // Default 7 seconds

                    if (browserSupport.cssCustomProperties) {
                      try {
                        const cssValue = getComputedStyle(document.documentElement)
                          .getPropertyValue("--period");
                        if (cssValue) {
                          const parsed = parseFloat(cssValue) * 1000;
                          if (parsed > 1000) {
                            period = parsed;
                          }
                        }
                      } catch (e) {
                        console.warn("Error reading CSS --period value:", e);
                      }
                    }

                    console.log(\`🕐 Enhanced background cycle: \${period}ms (\${period/1000}s)\`);
                    cycleTimer = setInterval(transitionToNext, period);
                  }

                  function setupFirstBg() {
                    if (!images.length)
                      return Promise.reject(new Error("No background images available"));

                    const firstSrc = images[0];
                    console.log(\`🎬 Enhanced setting up first background: \${firstSrc}\`);
                    
                    return preloadImage(firstSrc)
                      .then((img) => {
                        const first = createBackgroundElement(firstSrc);
                        bgContainer.appendChild(first);

                        setTimeout(() => {
                          first.classList.add("active");
                          
                          if (!browserSupport.cssCustomProperties) {
                            first.style.opacity = '1';
                          }
                          
                          isTransitioning = false;
                          console.log(\`✅ Enhanced first background active: bg1.png\`);
                        }, 100);
                      })
                      .catch((error) => {
                        console.error("Enhanced error setting up initial background:", error);
                        isTransitioning = false;
                      });
                  }

                  function initBackgrounds() {
                    console.log("🚀 Initializing enhanced background loader...");
                    
                    return fetchManifest()
                      .then((data) => {
                        manifest = data;
                        images = generateImagePaths();

                        console.log(\`📋 Enhanced manifest loaded: \${images.length} background images\`);

                        if (!images.length) {
                          console.error("Enhanced: No background images defined in manifest");
                          return;
                        }

                        return setupFirstBg();
                      })
                      .then(() => {
                        setupCycle();
                        console.log("✅ Enhanced background loader initialized successfully");
                      })
                      .catch((error) => {
                        console.error("❌ Enhanced failed to initialize backgrounds:", error);
                      });
                  }

                  if (document.readyState === "loading") {
                    document.addEventListener("DOMContentLoaded", initBackgrounds);
                  } else {
                    initBackgrounds();
                  }

                  // Export for debugging
                  window.bgLoader = {
                    browserSupport,
                    manifest: () => manifest,
                    images: () => images,
                    currentIndex: () => currentIndex,
                    forceNext: () => transitionToNext(),
                    restart: () => {
                      if (cycleTimer) clearInterval(cycleTimer);
                      setupCycle();
                    }
                  };

                })();
            `;
        document.head.appendChild(script);
      }, 1000);
    </script>
  </body>
</html>
