<!-- portfolio mini â€¢ self-contained and scoped -->
<style>
  .port{
    --font-ui: var(--font-ui, "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace);
    --fg: var(--fg, #e8e3d8);
    --bg: var(--bg, #0a0a0a);
    --cyan: #00ffc8;
    --vhs-warm: #ffdc80;
    --panel-border: rgba(0,255,200,.35);
    --panel-shadow: rgba(0,0,0,.65);
    font-family: var(--font-ui);
    color: var(--fg);
    margin: 0;
    padding: 0;
  }
  .port h2{ margin:.25rem 0 .4rem; font-size:1rem; }

  .port .tracks{
    display:flex; justify-content:center; align-items:center;
    gap:.5rem; padding:.35rem 0 .5rem; flex-wrap:wrap;
  }
  .port .trk{
    flex:0 0 auto; cursor:pointer;
    font:700 .95rem/1 var(--font-ui); letter-spacing:.02em;
    color:var(--fg); background:rgba(10,10,10,.8);
    border:1px dashed var(--cyan); border-radius:9px;
    padding:.5rem .7rem; user-select:none;
    transition:transform .08s ease;
  }
  .port .trk:active{ transform:scale(.98) }
  .port .trk.active{ 
    background:var(--cyan); 
    color:#0a0a0a; 
    box-shadow: 0 0 15px rgba(0,255,200,0.6);
  }
  .port .trk:focus-visible{ outline:2px solid var(--cyan); outline-offset:2px; }

  .port .player{
    background:rgba(5,5,5,.95); border:1px solid var(--panel-border);
    border-radius:14px; padding:.6rem .75rem; margin-bottom:1rem;
    box-shadow:0 6px 40px var(--panel-shadow), 0 0 20px rgba(0,255,200,0.15);
    position: relative;
    overflow: hidden;
  }

  /* Enhanced visualizer canvas */
  .port .visualizer-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    border-radius: 13px;
    opacity: 0.8;
    background: 
      radial-gradient(ellipse 100% 100% at center, 
        rgba(0,20,15,0.9) 0%, 
        rgba(0,10,8,0.95) 100%);
    transition: opacity 0.3s ease;
  }

  .port .controls{
    display:flex; align-items:center; gap:.75rem;
    position: relative;
    z-index: 2; /* Above visualizer */
  }
  .port .btn{
    width:48px; height:48px; border:0; background:transparent;
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; border-radius:10px;
  }
  .port .btn:focus-visible{ outline:2px solid var(--cyan); outline-offset:2px; }
  .port .btn svg{ 
    width:28px; height:28px; 
    fill:var(--fg); 
    filter: drop-shadow(0 0 4px rgba(0,255,200,0.3));
    display:block; 
  }

  .port .loading-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    background-size: 200% 100%;
    animation: loading-sweep 1.2s infinite linear;
    opacity: 0;
    transition: opacity 0.2s;
    border-radius: 14px 14px 0 0;
  }
  @keyframes loading-sweep {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .port .player.is-loading .loading-bar {
    opacity: 1;
  }

  .port .seek{ flex:1; display:flex; align-items:center; gap:.6rem; }
  .port .time{ font:600 .8rem/1 var(--font-ui); opacity:.9; min-width:4.2ch; text-align:right; }
  .port input[type="range"]{ -webkit-appearance:none; appearance:none; width:100%; height:6px; background:#222; border-radius:3px; }
  .port input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; }
  .port input[type="range"]::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:#fff; border:0; }
  .port input[type="range"]:focus-visible { outline: 2px solid var(--cyan); outline-offset: 4px; }

  .port .stage{
    position:relative; width:87%; margin:.6rem auto 1rem;
    aspect-ratio:16/9;
    background:#000; border:1px solid var(--panel-border);
    box-shadow:0 6px 40px var(--panel-shadow), 0 0 15px rgba(0,255,200,0.1);
    border-radius:12px; overflow:hidden; 
    touch-action:pan-y;
  }
  @media (max-width: 740px){
    .port .stage{ aspect-ratio:4/5; }
  }
  .port .stage img{ 
    width:100%; height:100%; object-fit:contain; display:block; background:#000;
    transition: opacity 0.3s ease;
  }
  .port .stage img.loading { 
    opacity: 0.4;
  }
  .port .stage.error::after {
    content: "Image failed to load";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: rgba(255,255,255,0.7);
    font-size: 0.9rem;
  }

  .port .nav{
    position:absolute; top:50%; transform:translateY(-50%);
    width:46px; height:46px; border-radius:12px;
    background:rgba(0,0,0,.75); color:var(--fg);
    border:1px solid var(--panel-border);
    box-shadow: 0 0 10px rgba(0,255,200,0.2);
    cursor:pointer; user-select:none;
    display:flex; align-items:center; justify-content:center;
    z-index:2;
    pointer-events:auto;
    font-size: 24px;
    font-family: Arial, sans-serif;
  }
  .port .nav.prev{ left:10px } .port .nav.next{ right:10px }
  .port .nav:focus-visible{ outline:2px solid var(--cyan); outline-offset:2px; }

  .port .sr-status {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>

<div class="port" id="port-root">
  <div class="tracks" id="tracks"></div>

  <div class="player" id="playerBox" role="group" aria-label="Music player">
    <div class="loading-bar"></div>
    <audio id="audio" preload="none" hidden></audio>
    <div class="controls">
      <button class="btn" id="playBtn" aria-label="Play" title="Play">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>

      <div class="seek">
        <span class="time" id="cur">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" step="0.1" aria-label="Seek">
        <span class="time" id="dur">0:00</span>
      </div>

      <button class="btn" id="muteBtn" aria-label="Mute" title="Mute">
        <svg viewBox="0 0 24 24"><path d="M4 9v6h4l5 4V5L8 9H4z"/></svg>
      </button>
    </div>
    <div id="playerStatus" class="sr-status" aria-live="polite"></div>
  </div>

  <div class="stage" id="stage">
    <button class="nav prev" id="prev" aria-label="Previous image">&lt;</button>
    <img id="shot" alt="Portfolio artwork" class="loading">
    <button class="nav next" id="next" aria-label="Next image">&gt;</button>
    <div id="galleryStatus" class="sr-status" aria-live="polite"></div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  const BASE_URL = window.location.pathname.includes('/assets/') 
    ? '../..' 
    : '.';
    
  const AUDIO_BASE = `${BASE_URL}/assets/audio/`;
  const IMAGE_BASE = `${BASE_URL}/assets/images/`;

  const tracks = [
    {file:'frark1999.mp3', label:'frark'},
    {file:'fulcrum.mp3',   label:'fulcrum'},
    {file:'sttd.mp3',      label:'sttd'},
    {file:'trance.mp3',    label:'trance'},
    {file:'whatwhat.mp3',  label:'whatwhat'},
  ];
  
  const tracksBar = document.getElementById('tracks');
  const audio = document.getElementById('audio');
  const playerBox = document.getElementById('playerBox');
  const playBtn = document.getElementById('playBtn');
  const muteBtn = document.getElementById('muteBtn');
  const seek = document.getElementById('seek');
  const curT = document.getElementById('cur');
  const durT = document.getElementById('dur');
  const playerStatus = document.getElementById('playerStatus');

  let activeBtn = null;
  let currentTrack = null;
  
  function formatTime(seconds) {
    if (!isFinite(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }
  
  function updateIcon(button, type) {
    const icons = {
      play: '<path d="M8 5v14l11-7z"/>',
      pause: '<path d="M6 5h4v14H6zm8 0h4v14h-4z"/>',
      speaker: '<path d="M4 9v6h4l5 4V5L8 9H4z"/>',
      mute: '<path d="M4 9v6h4l5 4V5L8 9H4z M16 9l5 5m0-5l-5 5" stroke="#fff" stroke-width="2" fill="none"/>'
    };
    
    button.querySelector('svg').innerHTML = icons[type];
    
    if (type === 'play') {
      button.setAttribute('aria-label', 'Play');
      button.setAttribute('title', 'Play');
    } else if (type === 'pause') {
      button.setAttribute('aria-label', 'Pause');
      button.setAttribute('title', 'Pause');
    } else if (type === 'speaker') {
      button.setAttribute('aria-label', 'Mute');
      button.setAttribute('title', 'Mute');
    } else if (type === 'mute') {
      button.setAttribute('aria-label', 'Unmute');
      button.setAttribute('title', 'Unmute');
    }
  }
  
  function announcePlayerState(message) {
    playerStatus.textContent = message;
  }
  
  // FIXED: Remove duplicate track creation
  tracks.forEach(track => {
    const button = document.createElement('button');
    button.className = 'trk';
    button.textContent = track.label;
    button.dataset.src = AUDIO_BASE + track.file;
    button.addEventListener('click', () => {
      if (activeBtn === button && !audio.paused) {
        audio.pause();
        return;
      }
      
      // Setup visualizer on first interaction
      if (!visualizerSetup) setupVisualizer();
      
      if (activeBtn) activeBtn.classList.remove('active');
      
      activeBtn = button;
      activeBtn.classList.add('active');
      
      if (currentTrack !== button.dataset.src) {
        currentTrack = button.dataset.src;
        audio.src = currentTrack;
        playerBox.classList.add('is-loading');
        announcePlayerState(`Loading track ${track.label}`);
      }
      
      audio.play().then(() => {
        playerBox.classList.remove('is-loading');
        announcePlayerState(`Playing ${track.label}`);
      }).catch(err => {
        console.error('Audio playback error:', err);
        playerBox.classList.remove('is-loading');
        announcePlayerState(`Failed to play ${track.label}`);
      });
    });
    
    tracksBar.appendChild(button);
  });
  
  playBtn.addEventListener('click', () => {
    if (!currentTrack) {
      const randomIndex = Math.floor(Math.random() * tracks.length);
      const randomTrackBtn = tracksBar.children[randomIndex];
      if (randomTrackBtn) randomTrackBtn.click();
      return;
    }
    
    if (!visualizerSetup) setupVisualizer();
    
    if (audio.paused) {
      playerBox.classList.add('is-loading');
      audio.play().then(() => {
        playerBox.classList.remove('is-loading');
        announcePlayerState(activeBtn ? `Playing ${activeBtn.textContent}` : "Playing audio");
      }).catch(err => {
        console.error('Audio playback error:', err);
        playerBox.classList.remove('is-loading');
        announcePlayerState("Failed to play audio");
      });
    } else {
      audio.pause();
      announcePlayerState("Paused");
    }
  });
  
  audio.addEventListener('play', () => {
    updateIcon(playBtn, 'pause');
    if (activeBtn) activeBtn.classList.add('active');
  });
  
  audio.addEventListener('pause', () => {
    updateIcon(playBtn, 'play');
  });
  
  audio.addEventListener('waiting', () => {
    playerBox.classList.add('is-loading');
  });
  
  audio.addEventListener('canplay', () => {
    playerBox.classList.remove('is-loading');
  });
  
  audio.addEventListener('loadedmetadata', () => {
    durT.textContent = formatTime(audio.duration);
    seek.max = audio.duration;
  });
  
  audio.addEventListener('timeupdate', () => {
    if (!audio.duration) return;
    curT.textContent = formatTime(audio.currentTime);
    seek.value = (audio.currentTime / audio.duration) * 100;
  });
  
  audio.addEventListener('ended', () => {
    stopVisualization();
    if (canvas) canvas.style.opacity = '0.2';
    
    if (activeBtn) {
      const nextTrack = activeBtn.nextElementSibling || tracksBar.firstElementChild;
      if (nextTrack && nextTrack.classList.contains('trk')) {
        nextTrack.click();
      }
    }
    announcePlayerState("Track ended");
  });
  
  audio.addEventListener('error', () => {
    console.error('Audio error', audio.error);
    playerBox.classList.remove('is-loading');
    announcePlayerState("Audio error occurred");
  });
  
  muteBtn.addEventListener('click', () => {
    audio.muted = !audio.muted;
    updateIcon(muteBtn, audio.muted ? 'mute' : 'speaker');
    announcePlayerState(audio.muted ? "Muted" : "Unmuted");
  });
  
  seek.addEventListener('input', () => {
    if (!audio.duration) return;
    const seekTime = (seek.value / 100) * audio.duration;
    audio.currentTime = seekTime;
    curT.textContent = formatTime(seekTime);
  });
  
  const IMAGE_COUNT = 31;
  const stage = document.getElementById('stage');
  const shot = document.getElementById('shot');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const galleryStatus = document.getElementById('galleryStatus');
  
  let currentImageIndex = 0;
  let imageLoaded = false;
  let images = [];
  
  for (let i = 1; i <= IMAGE_COUNT; i++) {
    images.push(`${IMAGE_BASE}bg${i}.png`);
  }
  
  // FIXED: Auto-load first image
  function showImage(index) {
    if (index < 0) index = images.length - 1;
    if (index >= images.length) index = 0;
    
    currentImageIndex = index;
    imageLoaded = false;
    
    shot.classList.add('loading');
    stage.classList.remove('error');
    
    shot.src = images[currentImageIndex];
    
    galleryStatus.textContent = `Loading image ${currentImageIndex + 1} of ${images.length}`;
  }
  
  shot.addEventListener('load', () => {
    imageLoaded = true;
    shot.classList.remove('loading');
    galleryStatus.textContent = `Image ${currentImageIndex + 1} of ${images.length}`;
  });
  
  shot.addEventListener('error', () => {
    shot.classList.remove('loading');
    stage.classList.add('error');
    galleryStatus.textContent = "Image failed to load";
    console.error('Failed to load image:', images[currentImageIndex]);
  });
  
  prev.addEventListener('click', () => {
    showImage(currentImageIndex - 1);
  });
  
  next.addEventListener('click', () => {
    showImage(currentImageIndex + 1);
  });
  
  stage.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      showImage(currentImageIndex - 1);
      e.preventDefault();
    } else if (e.key === 'ArrowRight') {
      showImage(currentImageIndex + 1);
      e.preventDefault();
    }
  });
  
  let touchStartX = 0;
  let touchEndX = 0;
  
  stage.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });
  
  stage.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    
    const threshold = 50;
    if (touchStartX - touchEndX > threshold) {
      showImage(currentImageIndex + 1);
    } else if (touchEndX - touchStartX > threshold) {
      showImage(currentImageIndex - 1);
    }
  }, { passive: true });
  
  // Audio Visualizer Setup
  let visualizerSetup = false;
  let audioContext = null;
  let analyser = null;
  let source = null;
  let canvas = null;
  let canvasCtx = null;
  let animationId = null;

  function setupVisualizer() {
    if (visualizerSetup || !audio || !playerBox) return;
    
    // Check for Web Audio API support
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) {
      console.warn('Web Audio API not supported - visualizer disabled');
      return;
    }

    visualizerSetup = true;
    audioContext = new AudioContext();
    analyser = audioContext.createAnalyser();
    
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;

    // Create canvas
    canvas = document.createElement('canvas');
    canvas.className = 'visualizer-canvas';
    playerBox.insertBefore(canvas, playerBox.firstChild);
    canvasCtx = canvas.getContext('2d');

    // Setup resize handler
    function resizeCanvas() {
      canvas.width = playerBox.offsetWidth;
      canvas.height = playerBox.offsetHeight;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
  }

  function connectAudioSource() {
    if (!audioContext || source) return;
    
    try {
      source = audioContext.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioContext.destination);
    } catch (err) {
      console.warn('Failed to connect audio source:', err);
    }
  }

  function startVisualization() {
    if (!analyser || !canvas || !canvasCtx) return;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    function draw() {
      if (audio.paused) {
        // Fade out visualization when paused
        canvasCtx.fillStyle = 'rgba(0, 20, 15, 0.15)';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        return;
      }
      
      animationId = requestAnimationFrame(draw);
      
      analyser.getByteFrequencyData(dataArray);
      
      const width = canvas.width;
      const height = canvas.height;
      
      // Clear with VHS-themed fade effect
      canvasCtx.fillStyle = 'rgba(0, 20, 15, 0.2)';
      canvasCtx.fillRect(0, 0, width, height);
      
      // Calculate average for background pulse
      const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
      
      // VHS-themed background pulse
      if (average > 25) {
        const intensity = Math.min(average / 255, 0.4);
        canvasCtx.fillStyle = `rgba(0, 255, 200, ${intensity * 0.12})`;
        canvasCtx.fillRect(0, 0, width, height);
        
        // Add warm VHS glow
        canvasCtx.fillStyle = `rgba(255, 220, 180, ${intensity * 0.08})`;
        canvasCtx.fillRect(0, 0, width, height);
      }
      
      // Enhanced frequency bars with VHS colors
      const barWidth = (width / bufferLength) * 2.5;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = (dataArray[i] / 255) * height * 0.7;
        
        // VHS-themed color gradient
        const hue = (i / bufferLength) * 80 + 160; // cyan to warm
        const saturation = 85 + (dataArray[i] / 255) * 15;
        const lightness = 45 + (dataArray[i] / 255) * 35;
        
        canvasCtx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.9)`;
        canvasCtx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
        
        x += barWidth;
      }
      
      // Enhanced center circle with VHS aesthetic
      const centerX = width / 2;
      const centerY = height / 2;
      const baseRadius = Math.min(width, height) * 0.12;
      const pulseRadius = baseRadius + (average / 255) * 25;
      
      // Outer glow
      canvasCtx.beginPath();
      canvasCtx.arc(centerX, centerY, pulseRadius + 8, 0, 2 * Math.PI);
      canvasCtx.strokeStyle = `rgba(0, 255, 200, ${Math.min(average / 255, 0.4)})`;
      canvasCtx.lineWidth = 3;
      canvasCtx.stroke();
      
      // Inner ring
      canvasCtx.beginPath();
      canvasCtx.arc(centerX, centerY, pulseRadius, 0, 2 * Math.PI);
      canvasCtx.strokeStyle = `rgba(255, 220, 180, ${Math.min(average / 255, 0.8)})`;
      canvasCtx.lineWidth = 2;
      canvasCtx.stroke();
    }
    
    draw();
  }

  function stopVisualization() {
    if (animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
  }

  // Modified audio event handlers
  audio.addEventListener('play', () => {
    updateIcon(playBtn, 'pause');
    if (activeBtn) activeBtn.classList.add('active');
    
    // Setup and start visualizer
    if (audioContext && audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    if (!source) connectAudioSource();
    startVisualization();
    
    // Show visualizer
    if (canvas) canvas.style.opacity = '0.6';
  });
  
  audio.addEventListener('pause', () => {
    updateIcon(playBtn, 'play');
    stopVisualization();
    
    // Fade out visualizer
    if (canvas) canvas.style.opacity = '0.2';
  });

  audio.addEventListener('ended', () => {
    stopVisualization();
    if (canvas) canvas.style.opacity = '0.2';
    
    if (activeBtn) {
      const nextTrack = activeBtn.nextElementSibling || tracksBar.firstElementChild;
      if (nextTrack && nextTrack.classList.contains('trk')) {
        nextTrack.click();
      }
    }
    announcePlayerState("Track ended");
  });

  // Setup visualizer when a track is first loaded
  tracks.forEach(track => {
    const button = document.createElement('button');
    button.className = 'trk';
    button.textContent = track.label;
    button.dataset.src = AUDIO_BASE + track.file;
    button.addEventListener('click', () => {
      if (activeBtn === button && !audio.paused) {
        audio.pause();
        return;
      }
      
      // Setup visualizer on first interaction
      if (!visualizerSetup) setupVisualizer();
      
      if (activeBtn) activeBtn.classList.remove('active');
      
      activeBtn = button;
      activeBtn.classList.add('active');
      
      if (currentTrack !== button.dataset.src) {
        currentTrack = button.dataset.src;
        audio.src = currentTrack;
        playerBox.classList.add('is-loading');
        announcePlayerState(`Loading track ${track.label}`);
      }
      
      audio.play().then(() => {
        playerBox.classList.remove('is-loading');
        announcePlayerState(`Playing ${track.label}`);
      }).catch(err => {
        console.error('Audio playback error:', err);
        playerBox.classList.remove('is-loading');
        announcePlayerState(`Failed to play ${track.label}`);
      });
    });
    
    tracksBar.appendChild(button);
  });

  // Modified play button handler
  playBtn.addEventListener('click', () => {
    if (!currentTrack) {
      const randomIndex = Math.floor(Math.random() * tracks.length);
      const randomTrackBtn = tracksBar.children[randomIndex];
      if (randomTrackBtn) randomTrackBtn.click();
      return;
    }
    
    if (!visualizerSetup) setupVisualizer();
    
    if (audio.paused) {
      playerBox.classList.add('is-loading');
      audio.play().then(() => {
        playerBox.classList.remove('is-loading');
        announcePlayerState(activeBtn ? `Playing ${activeBtn.textContent}` : "Playing audio");
      }).catch(err => {
        console.error('Audio playback error:', err);
        playerBox.classList.remove('is-loading');
        announcePlayerState("Failed to play audio");
      });
    } else {
      audio.pause();
      announcePlayerState("Paused");
    }
  });

  // FIXED: Initialize with first image
  showImage(0);

})();
</script>